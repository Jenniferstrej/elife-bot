elifePipeline {
    stage 'Checkout'
    checkout scm
    def commit = elifeGitRevision()

    echo "env.BUILDER_SCRIPTS_PREFIX"
    echo env.BUILDER_SCRIPTS_PREFIX

    stage 'Project tests'
    def stacknameCi = 'elife-bot-develop-ci'
    def testArtifact = "${env.BUILD_TAG}.junit.xml"
    elifeSwitchRevision stacknameCi, commit
    elifeCmd stacknameCi, 'cd /opt/elife-bot; ./project_tests.sh || echo TESTS FAILED!'
    elifeTestArtifact testArtifact, stacknameCi, '/opt/elife-bot/build/junit.xml'
    elifeVerifyJunitXml testArtifact

    stage 'End2end tests'
    def stacknameEnd2end = 'elife-bot-develop--end2end'
    elifeSwitchRevision stacknameEnd2end, commit
    elifeEnd2EndTest()

    stage 'Approval'
    elifeGitMoveToBranch commit, 'approved'
}
